<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TempMail</title>
    <script src="https://cdn.jsdelivr.net/npm/phoenix@1.7.2/priv/static/phoenix.min.js"></script>
</head>
<body>
    <h1>TempMail</h1>
    <div id="emails"></div>

    <script>
        let socket = new Phoenix.Socket("/socket", {});
        socket.connect();

        let channel = socket.channel("email:lobby", {});
        channel.join()
            .receive("ok", resp => { console.log("Joined successfully", resp) })
            .receive("error", resp => { console.log("Unable to join", resp) });

        channel.on("new_email", payload => {
            let emailDiv = document.createElement('div');
            emailDiv.innerHTML = `
                <h2>New Email</h2>
                <p>From: ${payload.from}</p>
                <p>To: ${payload.to}</p>
                <p>Subject: ${payload.subject}</p>
                <h3>Body:</h3>
                <pre>${payload.body}</pre>
                <h3>Attachments:</h3>
                <ul id="attachments-${Date.now()}"></ul>
            `;
            document.getElementById('emails').prepend(emailDiv);

            const attachmentsList = emailDiv.querySelector('ul');
            payload.attachments.forEach(attachment => {
                let li = document.createElement('li');
                let link = document.createElement('a');
                link.href = `data:${attachment.content_type};base64,${attachment.content}`;
                link.download = attachment.filename;
                link.textContent = attachment.filename;
                li.appendChild(link);
                attachmentsList.appendChild(li);
            });
        });
    </script>
</body>
</html>